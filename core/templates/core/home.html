{% extends "core/base.html" %}
{% load static %}

{% block title %}Control Center - KAIRCAM{% endblock %}
{% block body_class %}control-body{% endblock %}

{% block extra_css %}
<!-- Estilos específicos de Multistream -->
<link rel="stylesheet" href="{% static 'multistream/css/multistream_panel.css' %}">
{% endblock %}

{% block content %}
<main class="control-main">
  <div class="control-container-full">

    <div class="hero-section">
      <div class="hero-content">
        <div class="hero-left">
          <div class="status-indicator">
            <span class="status-dot"></span>
            <span class="status-text">Sistema Operativo</span>
          </div>
          <h1 class="hero-title">Panel de Control</h1>
          <p class="hero-subtitle">
            Control multicámara en tiempo real • Gestión profesional de streaming
          </p>
        </div>
        <div class="hero-stats">
          <div class="stat-item">
            <div class="stat-value" id="activeCamCount">0</div>
            <div class="stat-label">Cámaras Activas</div>
          </div>
          <div class="stat-divider"></div>
          <div class="stat-item">
            <div class="stat-value" id="streamStatus">OFFLINE</div>
            <div class="stat-label">Estado</div>
          </div>
        </div>
      </div>
    </div>

    <div class="main-grid">

      <div class="left-column">
        <section class="cameras-section">
          <div class="section-header">
            <div class="section-title-group">
              <h2 class="section-title">Fuentes de Video</h2>
              <div class="section-subtitle">Gestión de cámaras conectadas</div>
            </div>

            <div class="status-legends">
              <div class="legend-item">
                <span class="legend-dot on-air"></span>
                <span>Al Aire</span>
              </div>
              <div class="legend-item">
                <span class="legend-dot ready"></span>
                <span>Lista</span>
              </div>
              <div class="legend-item">
                <span class="legend-dot pending"></span>
                <span>Pendiente</span>
              </div>
            </div>
          </div>

          <div class="cameras-grid" id="camerasGrid"></div>

          <div class="cameras-empty" id="camerasEmpty" style="display: none;">
            <svg viewBox="0 0 24 24" class="empty-icon">
              <path d="M23 7l-7 5 7 5V7z" stroke="currentColor" stroke-width="2" fill="none"/>
              <rect x="1" y="5" width="15" height="14" rx="2" stroke="currentColor" stroke-width="2" fill="none"/>
            </svg>
            <div class="empty-text">No hay cámaras conectadas</div>
            <div class="empty-hint">Las cámaras aparecerán automáticamente al conectarse</div>
          </div>
        </section>
      </div>

      <aside class="right-column">
        <div class="preview-panel">
          
          <div class="preview-header">
            <div class="preview-title-group">
              <h3 class="preview-title">Program Output</h3>
              <div class="preview-subtitle">Salida principal de transmisión</div>
            </div>
            <div class="live-badge" id="liveBadge">
              <span class="live-dot"></span>
              <span>OFFLINE</span>
            </div>
          </div>

          <!-- PANEL DE ESTADO DE RETRANSMISIÓN -->
          <div class="restream-status-panel" id="restreamStatusPanel" style="display: none;">
            <div class="restream-status-header">
              <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"/>
                <polygon points="10 8 16 12 10 16 10 8" fill="currentColor"/>
              </svg>
              <span>Retransmitiendo en:</span>
            </div>
            <div class="restream-platforms-active" id="restreamPlatformsActive"></div>
          </div>
        
          <div class="preview-video-container" id="previewContainer">
            <video id="mainPreviewVideo" autoplay muted playsinline></video>

            <div class="preview-empty" id="previewEmpty">
              <div class="preview-empty-content">
                <svg viewBox="0 0 24 24" class="preview-empty-icon">
                  <rect x="2" y="3" width="20" height="14" rx="2" stroke="currentColor" stroke-width="2" fill="none"/>
                  <path d="M8 21h8M12 17v4" stroke="currentColor" stroke-width="2" fill="none"/>
                </svg>
                <div class="preview-empty-text">No hay señal al aire</div>
                <div class="preview-empty-hint">Seleccione una cámara para transmitir</div>
              </div>
            </div>

            <div class="preview-overlay" id="previewOverlay" style="display: none;">
              <div class="preview-info">
                <span class="preview-camera-label">CAM <span id="previewCamNumber">-</span></span>
                <span class="preview-time" id="previewTime">00:00:00</span>
              </div>
            </div>
          </div>

          <div class="preview-controls">
            <div class="controls-left">
              <button id="btnStopStream" class="btn-control btn-stop">
                <svg viewBox="0 0 24 24" class="btn-icon">
                  <rect x="6" y="6" width="12" height="12" rx="1" fill="currentColor"/>
                </svg>
                Detener
              </button>

              <button id="btnRestream" class="btn-control btn-restream" style="display: none;">
                <svg viewBox="0 0 24 24" class="btn-icon">
                  <path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z" stroke="currentColor" stroke-width="2" fill="none"/>
                </svg>
                Retransmitir
              </button>
            </div>

            <div class="volume-control">
              <svg viewBox="0 0 24 24" class="volume-icon">
                <path d="M11 5L6 9H2v6h4l5 4V5zM19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07" stroke="currentColor" stroke-width="2" fill="none"/>
              </svg>
              <input type="range" id="previewVolume" min="0" max="1" step="0.05" value="0">
              <span class="volume-value" id="volumeValue">0%</span>
            </div>
          </div>

        </div>
      </aside>

    </div>
  </div>
</main>

<!-- MODAL DE RETRANSMISIÓN -->
<div id="restreamModal" class="restream-modal" style="display: none;">
  <div class="restream-modal-overlay"></div>
  
  <div class="restream-modal-content">
      
      <div class="modal-header">
          <h3 class="modal-title">Iniciar Retransmisión</h3>
          <button id="btnCloseModal" style="background:none; border:none; color: #666; cursor: pointer; padding:0;">
            <svg viewBox="0 0 24 24" width="24" height="24"><path d="M18 6L6 18M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
          </button>
      </div>

      <div class="modal-body">
          <p style="margin-bottom: 20px; color: #94a3b8; font-size: 13px;">Selecciona plataformas destino configuradas:</p>
          
          <div class="platform-grid">
    
            {% if has_youtube %}
            <label class="platform-option youtube">
                <input type="checkbox" name="platform" value="youtube">
                <div class="platform-card">
                    <span class="material-icons platform-icon" style="color:#ff0000;">smart_display</span> 
                    <span class="platform-name">YouTube</span>
                </div>
            </label>
            {% endif %}
        
            {% if has_facebook %}
            <label class="platform-option facebook">
                <input type="checkbox" name="platform" value="facebook">
                <div class="platform-card">
                    <span class="material-icons platform-icon" style="color:#1877f2;">facebook</span>
                    <span class="platform-name">Facebook</span>
                </div>
            </label>
            {% else %}
            <div class="platform-option disabled" style="opacity:0.5; filter:grayscale(1);">
                 <div class="platform-card">
                    <span class="material-icons platform-icon">facebook</span>
                    <span class="platform-name">No Configurado</span>
                </div>
            </div>
            {% endif %}
        
        </div>

          {% if not has_youtube and not has_facebook %}
          <div style="text-align: center; padding: 20px; background: #1e2128; border-radius: 8px; margin-top: 10px;">
              <p style="color: #cbd5e1; margin-bottom: 10px;">No tienes plataformas configuradas.</p>
              <a href="{% url 'ajustes_retransmision' %}" class="btn-control" style="background: #3b82f6; color: white; padding: 8px 16px; text-decoration: none; border-radius: 4px; font-size: 12px;">Ir a Configuración</a>
          </div>
          {% else %}
          <div class="modal-actions">
              <button id="btnCancelRestream" class="btn-modal-cancel">Cancelar</button>
              <button id="btnStartRestream" class="btn-modal-start">EMITIR AHORA</button>
          </div>
          {% endif %}

      </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- HOME.JS (existente - fundamental para el sistema) -->
<script src="{% static 'core/js/home.js' %}"></script>

<!-- MULTISTREAM_PANEL.JS (nuevo - separado para organización) -->
<script src="{% static 'multistream/js/multistream_panel.js' %}"></script>
{% endblock %}